<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Horitzó + Sol</title>
  <style>
    body{ margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    #wrap{ position:relative; height:100vh; width:100vw; overflow:hidden; }
    canvas{ width:100%; height:100%; display:block; }
    .hud{
      position:absolute; left:12px; bottom:12px;
      background:rgba(0,0,0,.45); padding:10px 12px; border-radius:10px;
      backdrop-filter: blur(6px);
      font-size:14px; line-height:1.25;
    }
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
  <div class="hud" id="hud">—</div>
</div>
<script src="js/astronomy.browser.min.js"></script>
<script>
/**
 * CONFIG
 * - ajusta el rang d'azimut i d'altura a la teva UI
 */
const VIEW = {
  azMin: 220,
  azMax: 300,
  altMin: 0,
  altMax: 25,
  padding: {l: 40, r: 14, t: 14, b: 34},
  gridAzStep: 10,   // graus
  gridAltStep: 5,   // graus
  // colors (similar al look de la captura)
  colGrid: "rgba(255,0,180,0.35)",
  colGridBold: "rgba(255,0,180,0.55)",
  colHorizon: "rgba(255,255,255,0.9)",
  colSunPath: "rgba(255,200,0,0.95)",   // groc
  colSunPath2: "rgba(0,180,255,0.95)",  // blau (si vols 2a línia)
  colText: "rgba(255,0,180,0.9)"
};

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

/** Helpers mapping (az,alt) -> (x,y) */
function resizeCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.floor(canvas.clientWidth * dpr);
  const h = Math.floor(canvas.clientHeight * dpr);
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  return {w,h,dpr};
}
function mapX(az, W){
  const {l,r} = VIEW.padding;
  const x0 = l;
  const x1 = W - r;
  const t = (az - VIEW.azMin) / (VIEW.azMax - VIEW.azMin);
  return x0 + t * (x1 - x0);
}
function mapY(alt, H){
  const {t,b} = VIEW.padding;
  const y0 = H - b; // altMin
  const y1 = t;     // altMax
  const tt = (alt - VIEW.altMin) / (VIEW.altMax - VIEW.altMin);
  return y0 - tt * (y0 - y1);
}
function inViewAz(az){ return az >= VIEW.azMin && az <= VIEW.azMax; }
function inViewAlt(alt){ return alt >= VIEW.altMin && alt <= VIEW.altMax; }

/** Dibuixa graella + etiquetes d'angles */
function drawGrid(W,H){
  ctx.save();
  ctx.lineWidth = 1;

  // Verticals (azimut)
  for(let az = Math.ceil(VIEW.azMin/VIEW.gridAzStep)*VIEW.gridAzStep; az <= VIEW.azMax; az += VIEW.gridAzStep){
    const x = mapX(az, W);
    const bold = (az % 20 === 0);
    ctx.strokeStyle = bold ? VIEW.colGridBold : VIEW.colGrid;
    ctx.beginPath();
    ctx.moveTo(x, VIEW.padding.t);
    ctx.lineTo(x, H - VIEW.padding.b);
    ctx.stroke();

    // label a baix
    ctx.fillStyle = VIEW.colText;
    ctx.font = "14px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(`${az.toFixed(0)}°`, x, H - 6);
  }

  // Horitzontals (altura)
  for(let alt = Math.ceil(VIEW.altMin/VIEW.gridAltStep)*VIEW.gridAltStep; alt <= VIEW.altMax; alt += VIEW.gridAltStep){
    const y = mapY(alt, H);
    const bold = (alt % 10 === 0);
    ctx.strokeStyle = bold ? VIEW.colGridBold : VIEW.colGrid;
    ctx.beginPath();
    ctx.moveTo(VIEW.padding.l, y);
    ctx.lineTo(W - VIEW.padding.r, y);
    ctx.stroke();

    // label a l'esquerra
    ctx.fillStyle = VIEW.colText;
    ctx.font = "14px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillText(`${alt.toFixed(0)}°`, 6, y);
  }

  ctx.restore();
}

/** Dibuixa perfil d'horitzó (blanc) */
function drawHorizon(W,H, profile){
  if(!profile) return;
  const {az0, daz, alt} = profile;

  ctx.save();
  ctx.strokeStyle = VIEW.colHorizon;
  ctx.lineWidth = 2.2;
  ctx.beginPath();

  let started = false;
  for(let i=0; i<alt.length; i++){
    const az = az0 + i*daz;
    if(!inViewAz(az)) continue;
    const a = alt[i];
    const x = mapX(az, W);
    const y = mapY(a, H);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();
}

/** Dibuixa trajectòria del Sol (polilínia) + marques d'hora */
function drawSunPath(W,H, points, color){
  if(!points || !points.length) return;

  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.0;
  ctx.beginPath();

  let started = false;
  for(const p of points){
    if(!inViewAz(p.az) || !inViewAlt(p.alt)) continue;
    const x = mapX(p.az, W);
    const y = mapY(p.alt, H);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // Marques d'hora (cada 30 min per exemple) + etiqueta
  ctx.fillStyle = color;
  ctx.font = "16px system-ui";
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";

  for(const p of points){
    if(!p.label) continue;
    if(!inViewAz(p.az) || !inViewAlt(p.alt)) continue;
    const x = mapX(p.az, W);
    const y = mapY(p.alt, H);

    // marker
    ctx.beginPath();
    ctx.arc(x, y, 3.2, 0, Math.PI*2);
    ctx.fill();

    // label lleugerament separat
    ctx.fillText(p.label, x + 8, y);
  }

  ctx.restore();
}

/** Troba horitzó a un azimut (interpolació lineal sobre profile) */
function horizonAtAz(profile, az){
  const i = (az - profile.az0) / profile.daz;
  const i0 = Math.floor(i);
  const t = i - i0;
  if(i0 < 0 || i0+1 >= profile.alt.length) return null;
  return profile.alt[i0]*(1-t) + profile.alt[i0+1]*t;
}

/** Render principal */
function render(profile, sunPoints1, sunPoints2, sunAtMax){
  const {w:W,h:H} = resizeCanvas();
  ctx.clearRect(0,0,W,H);

  // fons
  ctx.fillStyle = "#111";
  ctx.fillRect(0,0,W,H);

  drawGrid(W,H);
  drawHorizon(W,H, profile);
  drawSunPath(W,H, sunPoints1, VIEW.colSunPath);
  if(sunPoints2) drawSunPath(W,H, sunPoints2, VIEW.colSunPath2);

  // HUD: clearance a l'azimut del màxim (si el tens)
  if(profile && sunAtMax){
    const hHor = horizonAtAz(profile, sunAtMax.az);
    const delta = (hHor==null) ? null : (sunAtMax.alt - hHor);
    const status = (delta==null) ? "—" : (delta > 0.3 ? "✅ Visible" : (delta > 0 ? "⚠️ Just" : "❌ Tapat"));
    hud.textContent = `Az ${sunAtMax.az.toFixed(1)}° · Sol ${sunAtMax.alt.toFixed(2)}° · Horitzó ${hHor?.toFixed(2)}° · Δ ${delta?.toFixed(2)}° · ${status}`;
  }else{
    hud.textContent = "—";
  }
}

/* =========================
   DEMO DATA (SUBSTITUEIX-HO)
   ========================= */

/** Exemple de perfil fictici (substitueix-ho pel teu JSON real) */
const demoProfile = (() => {
  const az0 = 220, daz = 0.2;
  const n = Math.round((300-220)/daz)+1;
  const alt = new Array(n).fill(0).map((_,i)=>{
    const az = az0 + i*daz;
    // “muntanya” fictícia centrada a 262°
    const peak = 6 * Math.exp(-0.5*Math.pow((az-262)/6,2));
    // ondulació suau
    return 0.6 + 0.4*Math.sin((az-220)/8) + peak;
  });
  return {az0,daz,alt};
})();

/** Exemple de sol fictici (substitueix per astronomy-engine) */
function demoSunPath(){
  const pts = [];
  // trajectòria paramètrica (només per veure-ho pintat)
  for(let t=0; t<=1; t+=0.01){
    const az = 235 + 55*t;
    const alt = 10 - 9*t; // baixa fins ~1°
    pts.push({az, alt});
  }
  // labels d'exemple
  pts.push({az:240, alt:6.5, label:"17:50"});
  pts.push({az:275, alt:2.0, label:"22:43"});
  return pts;
}
const demoSun1 = demoSunPath();
const demoSunAtMax = {az:270, alt:2.0}; // màxim a 2°

window.addEventListener("resize", ()=>render(demoProfile, demoSun1, null, demoSunAtMax));
render(demoProfile, demoSun1, null, demoSunAtMax);
</script>
</body>
</html>
